{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .statistics-container {
    padding: 20px;
  }
  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: var(--dashboard-card-bg, #fff);
    border: 1px solid #d7dbe3;
    border-radius: 16px;
    padding: 20px 24px 14px 24px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: relative;
  }
  .stat-icon {
    font-size: 2em;
    margin-bottom: 8px;
    color: #007bff;
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.1));
  }
  .stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #0d47a1;
    margin-bottom: 3px;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 0 #eee;
  }
  .stat-label {
    color: #222;
    font-size: 1em;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
    font-weight: 500;
  }
  .stat-card .stat-label span {
    color: #555 !important;
    font-size: 0.98em;
  }
  .trend {
    display: inline-block;
    font-size: 1em;
    margin-left: 10px;
    vertical-align: middle;
    font-weight: 600;
    text-shadow: none;
  }
  .trend.up {
    color: #28a745;
  }
  .trend.down {
    color: #dc3545;
  }
  .trend.zero {
    color: #f7b100;
  }
  .sparkline-wrapper {
    width: 100%;
    height: 35px;
    margin-top: 6px;
  }

  .charts-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }
  .chart-container {
    background: var(--dashboard-card-bg, #fff);
    border: 1px solid #d7dbe3;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  }
  .chart-title {
    font-size: 1.18em;
    font-weight: 600;
    margin-bottom: 13px;
    text-align: center;
    color: #162447;
    letter-spacing: 0.2px;
  }
  .chart-canvas {
    max-height: 370px;
  }

  .tables-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }
  .table-container {
    background: var(--dashboard-card-bg, #fff);
    border: 1px solid #d7dbe3;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  }
  .table-header {
    background: #007bff;
    color: #fff;
    padding: 15px;
    font-weight: bold;
    font-size: 1em;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 0 #003366;
  }
  .stats-table {
    width: 100%;
    border-collapse: collapse;
  }
  .stats-table th,
  .stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e6e9f0;
  }
  .stats-table th {
    background: #e7eaf1 !important;
    color: #111 !important;
    font-weight: 600;
    letter-spacing: 0.4px;
    font-size: 1em;
  }
  .stats-table tr:hover {
    background: #e3eafd !important;
  }
  .play-count {
    font-weight: bold;
    color: #21784e;
  }
  .stats-table td small {
    color: #a2a5aa !important;
    font-size: 0.98em;
  }
  @media (max-width: 1000px) {
    .charts-container,
    .tables-container {
      grid-template-columns: 1fr;
    }
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --dashboard-card-bg: #1e232b;
    }
    .stat-card,
    .chart-container,
    .table-container {
      background: var(--dashboard-card-bg, #222);
      color: #fff;
      border-color: #343a40;
    }
    .chart-title,
    .stat-number,
    .stat-label,
    .stats-table th,
    .table-header {
      color: #fff !important;
      text-shadow: none;
    }
    .stats-table th {
      background: #24324d !important;
    }
    .stats-table td {
      color: #f7fafc !important;
    }
    .stats-table tr:hover {
      background: #213049 !important;
    }
    .play-count {
      color: #00fa9a;
    }
    .stat-icon {
      filter: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="statistics-container">
  <h1>{{ title }}</h1>
  <div class="stats-summary">
    <!-- Total Canciones -->
    <div class="stat-card">
      <div class="stat-icon">üéµ</div>
      <div class="stat-number">{{ stats_summary.total_songs|default:0 }}</div>
      <div class="stat-label">Total Canciones</div>
    </div>
    <!-- Total Artistas -->
    <div class="stat-card">
      <div class="stat-icon">üë§</div>
      <div class="stat-number">{{ stats_summary.total_artists|default:0 }}</div>
      <div class="stat-label">Total Artistas</div>
    </div>
    <!-- Total Reproducciones + tendencia y sparkline -->
    <div class="stat-card">
      <div class="stat-icon">‚ñ∂Ô∏è</div>
      <div class="stat-number">
        {{ stats_summary.total_plays|default:0|intcomma }}
        {% if stats_summary.trend > 0 %}
          <span class="trend up">‚ñ≤ {{ stats_summary.trend|floatformat:1 }}%</span>
        {% else %}
          {% if stats_summary.trend < 0 %}
            <span class="trend down">‚ñº {{ stats_summary.trend|floatformat:1 }}%</span>
          {% else %}
            <span class="trend zero">‚óè 0%</span>
          {% endif %}
        {% endif %}
      </div>
      <div class="stat-label">
        Total Reproducciones
        <span style="font-size: 0.92em; color: #888"
          >(√∫ltima semana vs. previa)</span>
      </div>
      <div class="sparkline-wrapper">
        <canvas id="playsSparkline" height="30"></canvas>
      </div>
    </div>
    <!-- Promedio por Canci√≥n -->
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-number">
        {{ stats_summary.avg_plays_per_song|floatformat:0|default:0 }}
      </div>
      <div class="stat-label">Promedio de reproducciones por Canci√≥n</div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="charts-container">
    <div class="chart-container">
      <div class="chart-title">Top 10 Artistas M√°s Escuchados</div>
      <canvas id="artistsBarChart" class="chart-canvas"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">Top 10 Canciones M√°s Reproducidas</div>
      <canvas id="songsPieChart" class="chart-canvas"></canvas>
    </div>
  </div>

  <!-- Tablas de datos -->
  <div class="tables-container">
    <div class="table-container">
      <div class="table-header">Top 10 Artistas M√°s Escuchados</div>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Posici√≥n</th>
            <th>Artista</th>
            <th>Total Reproducciones</th>
          </tr>
        </thead>
        <tbody>
          {% for artist in top_artists %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ artist.name }}</td>
            <td class="play-count">{{ artist.total_plays|default:0 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3" style="text-align: center; padding: 20px; color: #6c757d">
              No hay datos de reproducciones disponibles
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-container">
      <div class="table-header">Top 10 Canciones M√°s Reproducidas</div>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Posici√≥n</th>
            <th>Canci√≥n</th>
            <th>Reproducciones</th>
          </tr>
        </thead>
        <tbody>
          {% for song in top_songs %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              <strong>{{ song.title }}</strong><br />
              <small
                >{{ song.artist.name|default:"Artista desconocido" }}</small>
            </td>
            <td class="play-count">{{ song.play_count }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3" style="text-align: center; padding: 20px; color: #6c757d">
              No hay canciones con reproducciones disponibles
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // ==== Colores para gr√°ficos ====
      function generateColors(n) {
          const palette = [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
              '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
          ];
          if (n <= palette.length) return palette.slice(0, n);
          // genera m√°s colores si se necesita
          let colors = palette.slice();
          while(colors.length < n) {
              colors.push('#' + Math.floor(Math.random()*16777215).toString(16));
          }
          return colors.slice(0, n);
      }

      // ==== Sparkline ====
      const sparklineData = {{ stats_summary.sparkline_data|safe }};
      const sparklineLabels = {{ stats_summary.sparkline_labels|safe }};
      new Chart(document.getElementById('playsSparkline').getContext('2d'), {
          type: 'line',
          data: {
              labels: sparklineLabels,
              datasets: [{
                  data: sparklineData,
                  borderColor: '#007bff',
                  fill: false,
                  tension: 0.35,
                  pointRadius: 0,
                  borderWidth: 2,
              }]
          },
          options: {
              plugins: { legend: { display: false }, tooltip: { enabled: false } },
              scales: { x: { display: false }, y: { display: false } },
              elements: { line: { borderJoinStyle: 'round' } },
              animation: false,
          }
      });

      // ==== Gr√°fico de barras horizontal: Artistas ====
      const artistsData = {{ artists_chart_data|safe }};
      new Chart(document.getElementById('artistsBarChart').getContext('2d'), {
          type: 'bar',
          data: {
              labels: artistsData.labels,
              datasets: [{
                  label: 'Reproducciones',
                  data: artistsData.data,
                  backgroundColor: '#007bff',
                  borderRadius: 7,
                  borderSkipped: false,
              }]
          },
          options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  x: {
                      beginAtZero: true,
                      ticks: { callback: value => value.toLocaleString() }
                  }
              },
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: {
                          label: ctx => 'Reproducciones: ' + ctx.parsed.x.toLocaleString()
                      }
                  }
              }
          }
      });

      // ==== Gr√°fico de doughnut: Canciones ====
      const songsData = {{ songs_chart_data|safe }};
      const colors = generateColors(songsData.data.length);
      new Chart(document.getElementById('songsPieChart').getContext('2d'), {
          type: 'doughnut',
          data: {
              labels: songsData.labels,
              datasets: [{
                  data: songsData.data,
                  backgroundColor: colors,
                  borderColor: '#fff',
                  borderWidth: 2
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '65%',
              plugins: {
                  legend: {
                      position: 'bottom',
                      labels: {
                          boxWidth: 12,
                          padding: 10,
                          font: { size: 11 }
                      }
                  },
                  tooltip: {
                      callbacks: {
                          label: ctx => {
                              const label = ctx.label || '';
                              const value = ctx.parsed;
                              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                              const pct = total ? ((value / total) * 100).toFixed(1) : 0;
                              return `${label}: ${value.toLocaleString()} (${pct}%)`;
                          }
                      }
                  }
              }
          }
      });
  });
</script>
{% endblock %}
